<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>User Page</title>
    <link rel="stylesheet" href="/style.css">
  </head>
  <body>
    <table><tr><td><a href="index.html"><img src="/favicon.ico" ></a></td><td style="padding:10px"><h1>User Editor Page</h1></td></tr></table>
    <p>Who are you?</p>
    <select id="selectBlock" onchange="changeDisplayedUser()">
      %content%
    </select>
    <br>
    <br>
    <div id="userSection">
      Select a user
    </div>
    
  </body>
  
  <script>
    //A function for making a new AJAX request. Has actions to complete on success, 404, 500, and other. Passes the requester object to functions
    var actionRequest = function(parameter, on200, on404, on500, onOther) {
      var httpRequester = new XMLHttpRequest() //Make a new one of these
      //Ideally, we will just replace the html in the "userSelection" div with whatever we get here
      httpRequester.responseType = "text"; //This defines what type of data will be returned from the request
      //NOTE: nameVAL should be the user's ID number, not their displayed name!
      httpRequester.open("GET", parameter); //Sends a request for the given user's information
      httpRequester.setRequestHeader("Cache-Control","no-cache") //Apparently requests will be cached and no data will be resent after stuff is changed
      httpRequester.send(null);
      
      var test = function(func) {
        if (typeof(func) != "function") {
          if ((typeof(func) == "string" && func.length > 0) && func != null) {
            alert(func);
          }
        } else {
          func(httpRequester);
        }
      }
      
      httpRequester.onreadystatechange = function() {
        if (httpRequester.readyState == XMLHttpRequest.DONE) { //If we have processed the request
          if (httpRequester.status == 200) { //Our request was successful
            test(on200);
          } else if (httpRequester.status == 404) {
            test(on404);
          } else if (httpRequester.status == 500) {
            test(on500);
          } else {
            test(onOther);
          }
        }
      }
    }
    
    //Utility function
    var requestString = function(type, id, name) {
      return "userRequest?type="+encodeURIComponent(type)+"&user="+encodeURIComponent(id)+"&name="+encodeURIComponent(name)
    }
    
    //This function will change the requisite fields so that the user can see what's going on
    //Uses AJAX to get each user's data
    var changeDisplayedUser = function() {
      var nameVal = document.getElementById("selectBlock").value;
      if (nameVal.length < 1) { //If they select this option, just get rid of the displayed data
        document.getElementById("userSection").innerHTML = ""; //Remove it all
        return; //Don't do anything else
      }
      actionRequest(requestString("get", nameVal),
         function(httpRequester) {
        document.getElementById("userSection").innerHTML = httpRequester.responseText; //Set the inner html to the proper user data
        }, 
                    "User not found!", "Server Error!\nCould not get user!", "Invalid Server Response!"
      )
    }
    
    //Requests to set the users real name to this value. Gets id from select block
    var setName = function(name) {
      var id = document.getElementById("selectBlock").value;
      actionRequest(
        requestString("set", id, name),
        null, "User not found somehow...", "Internal Server Error", "Unknown response"
      );
      changeDisplayedUser();
    }
    
    var removeName = function(name) {
      var id = document.getElementById("selectBlock").value;
      actionRequest(
        requestString("remove", id, name),
        null, "User not found somehow...", "Internal Server Error", "Unknown response"
      );
      changeDisplayedUser();
    }
     
    var newName = function() {
      var id = document.getElementById("selectBlock").value;
      var name = document.getElementById("nameSubmit").value;
      if (name.length > 0) {
        actionRequest(
          requestString("add", id, name),
          null, "User not found somehow...", "Internal Server Error", "Unknown response"
        );
      changeDisplayedUser();
      }
    }
    
  </script>
  
</html>
